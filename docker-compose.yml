services:
  # =========================
  # 1. MYSQL DATABASE
  # =========================
  mysql:
    image: mysql:8.0
    container_name: bizflow-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: 123456
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db/init:/docker-entrypoint-initdb.d
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 2. REDIS CACHE
  # =========================
  redis:
    image: redis:7
    container_name: bizflow-redis
    restart: always
    ports:
      - "6379:6379"
    networks:
      - bizflow-net
    mem_limit: 256m

  # =========================
  # 3. RABBITMQ (Message Queue)
  # =========================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: bizflow-rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - bizflow-net
    mem_limit: 128m

  # =========================
  # 4. KAFKA + ZOOKEEPER
  # =========================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: bizflow-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - bizflow-net
    mem_limit: 256m

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: bizflow-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 5. API GATEWAY (SPRING CLOUD GATEWAY)
  # =========================
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: bizflow-gateway
    restart: always
    ports:
      - "8000:8000"
    depends_on:
      - auth-service
      - user-service
      - product-service
      - inventory-service
      - order-service
      - customer-service
      - promotion-service
      - payment-service
      # - report-service  # Disabled temporarily
      - ai_service
      - fcm-service
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 6. AUTH SERVICE
  # =========================
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: bizflow-auth-service
    restart: always
    ports:
      - "8081:8081"
    depends_on:
      - mysql
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 7. USER SERVICE
  # =========================
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: bizflow-user-service
    restart: always
    ports:
      - "8084:8084"
    depends_on:
      - mysql
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 8. PRODUCT SERVICE
  # =========================
  product-service:
    build:
      context: ./product-service
      dockerfile: Dockerfile
    container_name: bizflow-product-service
    restart: always
    ports:
      - "8082:8082"
    depends_on:
      - mysql
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 9. INVENTORY SERVICE
  # =========================
  inventory-service:
    build:
      context: ./inventory-service
      dockerfile: Dockerfile
    container_name: bizflow-inventory-service
    restart: always
    ports:
      - "8085:8085"
    depends_on:
      - mysql
      - kafka
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 10. ORDER SERVICE
  # =========================
  order-service:
    build:
      context: ./order-service
      dockerfile: Dockerfile
    container_name: bizflow-order-service
    restart: always
    ports:
      - "8083:8083"
    depends_on:
      - mysql
      - kafka
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 11. CUSTOMER SERVICE
  # =========================
  customer-service:
    build:
      context: ./customer-service
      dockerfile: Dockerfile
    container_name: bizflow-customer-service
    restart: always
    ports:
      - "8086:8086"
    depends_on:
      - mysql
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 12. PROMOTION SERVICE
  # =========================
  promotion-service:
    build:
      context: ./promotion-service
      dockerfile: Dockerfile
    container_name: bizflow-promotion-service
    restart: always
    ports:
      - "8087:8087"
    depends_on:
      - mysql
      - redis
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 13. PAYMENT SERVICE
  # =========================
  payment-service:
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    container_name: bizflow-payment-service
    restart: always
    ports:
      - "8088:8088"
    depends_on:
      - mysql
      - kafka
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 14. REPORT SERVICE
  # =========================
  # TEMPORARILY DISABLED - Compilation errors with cross-service dependencies
  # TODO: Fix report-service entities and dependencies
  # report-service:
  #   build:
  #     context: ./report-service
  #     dockerfile: Dockerfile
  #   container_name: bizflow-report-service
  #   restart: always
  #   ports:
  #     - "8089:8089"
  #   depends_on:
  #     - mysql
  #     - kafka
  #   networks:
  #     - bizflow-net
  #   mem_limit: 512m

  # =========================
  # 15. AI SERVICE (PYTHON FASTAPI)
  # =========================
  ai_service:
    build:
      context: ./ai_service
      dockerfile: Dockerfile
    container_name: bizflow-ai
    restart: always
    ports:
      - "5000:5000"
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 16. FCM SERVICE (SKELETON)
  # =========================
  fcm-service:
    build:
      context: ./fcm-service
      dockerfile: Dockerfile
    container_name: bizflow-fcm-service
    restart: always
    ports:
      - "8091:8091"
    networks:
      - bizflow-net
    mem_limit: 256m

  # =========================
  # 17. WORKER SERVICE (SCHEDULER)
  # =========================
  worker-service:
    build:
      context: ./worker-service
      dockerfile: Dockerfile
    container_name: bizflow-worker-service
    restart: always
    ports:
      - "8092:8092"
    depends_on:
      - mysql
      - kafka
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 18. FRONTEND WEB (NGINX)
  # =========================
  frontend:
    build:
      context: ./FE
      dockerfile: Dockerfile
    container_name: bizflow-frontend
    ports:
      - "3000:80"
    depends_on:
      - gateway
    volumes:
      - ./FE/assets:/usr/share/nginx/html/assets
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 19. PHPMYADMIN (DB WEB UI)
  # =========================
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: bizflow-phpmyadmin
    restart: always
    ports:
      - "8080:80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: 123456
    depends_on:
      - mysql
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 20. NIFI (DATA ORCHESTRATION)
  # =========================
  nifi:
    image: apache/nifi:1.23.2
    container_name: bizflow-nifi
    restart: unless-stopped
    ports:
      - "8090:8080"
    environment:
      NIFI_WEB_HTTP_PORT: 8080
      NIFI_JVM_HEAP_INIT: 1g
      NIFI_JVM_HEAP_MAX: 1g
    volumes:
      - nifi_state:/opt/nifi/nifi-current/state
    depends_on:
      - promotion-service
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 21. KONG API GATEWAY (OPTIONAL LAYER)
  # =========================
  kong:
    image: kong:3.6
    container_name: bizflow-kong
    restart: always
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    ports:
      - "8010:8000"
      - "8011:8001"
    volumes:
      - ./kong:/kong/declarative
    depends_on:
      - gateway
    networks:
      - bizflow-net
    mem_limit: 256m

  # =========================
  # 22. PROMETHEUS
  # =========================
  prometheus:
    image: prom/prometheus:latest
    container_name: bizflow-prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - bizflow-net
    mem_limit: 256m

  # =========================
  # 23. GRAFANA
  # =========================
  grafana:
    image: grafana/grafana:latest
    container_name: bizflow-grafana
    restart: always
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - bizflow-net
    mem_limit: 256m

volumes:
  mysql_data:
  nifi_state:
  prometheus_data:
  grafana_data:

networks:
  bizflow-net:
    driver: bridge
