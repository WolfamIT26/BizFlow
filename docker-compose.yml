services:

  # =========================
  # 1. MYSQL DATABASE
  # =========================
  mysql:
    image: mysql:8.0
    container_name: bizflow-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      MYSQL_ROOT_HOST: "%"
      MYSQL_DATABASE: ${MYSQL_DATABASE:-bizflow_db}
      MYSQL_USER: ${MYSQL_USER:-bizflow}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-bizflow123}
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db/init:/docker-entrypoint-initdb.d
    networks:
      - bizflow-net
    mem_limit: 512m

  # =========================
  # 2. REDIS CACHE
  # =========================
  redis:
    image: redis:7
    container_name: bizflow-redis
    restart: always
    ports:
      - "6379:6379"
    networks:
      - bizflow-net
    mem_limit: 256m

  # =========================
  # 3. RABBITMQ (Message Queue)
  # =========================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: bizflow-rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672" # dashboard
    networks:
      - bizflow-net
    mem_limit: 128m

  # =========================
  # 4. API GATEWAY (SPRING CLOUD GATEWAY)
  # =========================
  gateway:
    build:
      context: ./BizFlow.Gateway
      dockerfile: Dockerfile
    container_name: bizflow-gateway
    restart: always
    ports:
      - "8000:8000"
    depends_on:
      - sales-service
      - catalog-service
      - inventory-service
      - customer-service
      - authentication-service
      - report-service
      - promotion-service
      - ai_service
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 5. SALES SERVICE (SPRING BOOT)
  # =========================
  sales-service:
    build:
      context: ./BizFlow.SalesService
      dockerfile: Dockerfile
    container_name: bizflow-sales-service
    restart: always
    ports:
      - "8081:8081"
    environment:
      DB_HOST: mysql
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      REDIS_HOST: redis
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      CATALOG_SERVICE_URL: http://catalog-service:8083
      INVENTORY_SERVICE_URL: http://inventory-service:8084
      CUSTOMER_SERVICE_URL: http://customer-service:8085
      AUTH_SERVICE_URL: http://authentication-service:8086
      PROMOTION_SERVICE_URL: http://promotion-service:8082
    depends_on:
      - mysql
      - redis
      - rabbitmq
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 6. CATALOG SERVICE (SPRING BOOT)
  # =========================
  catalog-service:
    build:
      context: ./BizFlow.CatalogService
      dockerfile: Dockerfile
    container_name: bizflow-catalog-service
    restart: always
    ports:
      - "8083:8083"
    environment:
      DB_HOST: mysql
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      INVENTORY_SERVICE_URL: http://inventory-service:8084
    depends_on:
      - mysql
      - inventory-service
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 7. INVENTORY SERVICE (SPRING BOOT)
  # =========================
  inventory-service:
    build:
      context: ./BizFlow.InventoryService
      dockerfile: Dockerfile
    container_name: bizflow-inventory-service
    restart: always
    ports:
      - "8084:8084"
    environment:
      DB_HOST: mysql
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      CATALOG_SERVICE_URL: http://catalog-service:8083
    depends_on:
      - mysql
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 8. CUSTOMER SERVICE (SPRING BOOT)
  # =========================
  customer-service:
    build:
      context: ./BizFlow.CustomerService
      dockerfile: Dockerfile
    container_name: bizflow-customer-service
    restart: always
    ports:
      - "8085:8085"
    environment:
      DB_HOST: mysql
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      REDIS_HOST: redis
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      SALES_SERVICE_URL: http://sales-service:8081
    depends_on:
      - mysql
      - redis
      - rabbitmq
      - sales-service
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 9. AUTHENTICATION SERVICE (SPRING BOOT)
  # =========================
  authentication-service:
    build:
      context: ./BizFlow.AuthenticationService
      dockerfile: Dockerfile
    container_name: bizflow-authentication-service
    restart: always
    ports:
      - "8086:8086"
    environment:
      DB_HOST: mysql
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      REDIS_HOST: redis
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
    depends_on:
      - mysql
      - redis
      - rabbitmq
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 10. REPORT SERVICE (SPRING BOOT)
  # =========================
  report-service:
    build:
      context: ./BizFlow.ReportService
      dockerfile: Dockerfile
    container_name: bizflow-report-service
    restart: always
    ports:
      - "8087:8087"
    environment:
      DB_HOST: mysql
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      SALES_SERVICE_URL: http://sales-service:8081
      CATALOG_SERVICE_URL: http://catalog-service:8083
      INVENTORY_SERVICE_URL: http://inventory-service:8084
      CUSTOMER_SERVICE_URL: http://customer-service:8085
      AUTH_SERVICE_URL: http://authentication-service:8086
    depends_on:
      - mysql
      - sales-service
      - catalog-service
      - inventory-service
      - customer-service
      - authentication-service
    networks:
      - bizflow-net
    mem_limit: 1024m

  # =========================
  # 11. AI SERVICE (PYTHON FASTAPI)
  # =========================
  ai_service:
    build:
      context: ./BizFlow.AIService
      dockerfile: Dockerfile
    container_name: bizflow-ai
    restart: always
    ports:
      - "5000:5000"
    networks:
      - bizflow-net
    mem_limit: 1024m
  # =========================
  # 12. FRONTEND WEB (NGINX)
  # =========================
  frontend:
    build:
      context: ./BizFlow.Frontend
      dockerfile: Dockerfile
    container_name: bizflow-frontend
    ports:
      - "3000:80"
    depends_on:
      - gateway
    volumes:
      - ./BizFlow.Frontend/assets:/usr/share/nginx/html/assets
      - ./BizFlow.Frontend/pages:/usr/share/nginx/html/pages
    networks:
      - bizflow-net
    mem_limit: 1024m
  # =========================
  # 13. PHPMYADMIN (DB WEB UI)
  # =========================
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: bizflow-phpmyadmin
    restart: always
    ports:
      - "8088:80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
    depends_on:
      - mysql
    networks:
      - bizflow-net
    mem_limit: 1024m
  # =========================
  # 14. PROMOTION SERVICE (SPRING BOOT MICROSERVICE)
  # =========================
  promotion-service:
    build:
      context: ./BizFlow.PromotionService
      dockerfile: Dockerfile
    container_name: bizflow-promotion-service
    restart: always
    ports:
      - "8082:8082"
    environment:
      DB_HOST: mysql
      DB_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
      REDIS_HOST: redis
    depends_on:
      - mysql
      - redis
    networks:
      - bizflow-net
    mem_limit: 512m
  # =========================
  # 15. NIFI (DATA ORCHESTRATION)
  # =========================
  nifi:
    image: apache/nifi:1.23.2
    container_name: bizflow-nifi
    restart: unless-stopped
    ports:
      - "8090:8080"
    environment:
      NIFI_WEB_HTTP_PORT: 8080
      NIFI_JVM_HEAP_INIT: 1g
      NIFI_JVM_HEAP_MAX: 1g
    volumes:
      - nifi_state:/opt/nifi/nifi-current/state
    depends_on:
      - promotion-service
    networks:
      - bizflow-net
    mem_limit: 512m

# =========================
# VOLUMES
# =========================
volumes:
  mysql_data:
  nifi_state:
# =========================
# NETWORK
# =========================
networks:
  bizflow-net:
    driver: bridge

