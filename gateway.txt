================================================================================
BizFlow API Gateway
================================================================================

GIỚI THIỆU
----------
API Gateway là điểm vào chính cho tất cả các request từ client. Nó sử dụng 
Spring Cloud Gateway để route request đến các microservice khác nhau.

KIẾN TRÚC
---------
Client → Gateway (8000) → Backend API (8080) / AI Service (5000)
            ↓
         Routing
         CORS Handling
         Request/Response Filtering

PORT & ENDPOINT
---------------
Service         Port     Endpoint
Gateway         8000     http://localhost:8000
Backend         8080     http://localhost:8080
AI Service      5000     http://localhost:5000

ROUTE CONFIGURATION
-------------------

1. Backend API Routes
   - Path: /api/**
   - Target: http://backend:8080
   - Ví dụ:
     * /api/auth/login → http://backend:8080/api/auth/login
     * /api/products → http://backend:8080/api/products

2. AI Service Routes
   - Path: /ai/**
   - Target: http://ai_service:5000
   - Ví dụ:
     * /ai/analyze → http://ai_service:5000/analyze

3. Health Check
   - Path: /health/**
   - Target: http://backend:8080
   - Ví dụ: /health/status

4. Actuator
   - Path: /actuator/**
   - Target: http://backend:8080
   - Ví dụ: /actuator/metrics

CORS CONFIGURATION
------------------
Gateway được cấu hình hỗ trợ CORS với:
- Allowed Origins: * (tất cả domain)
- Allowed Methods: GET, POST, PUT, DELETE, OPTIONS, PATCH
- Allowed Headers: * (tất cả headers)
- Max Age: 3600 giây

CHẠY GATEWAY
------------

Cách 1: Docker Compose (Recommended)
  docker-compose up -d
  
  Gateway sẽ tự động start cùng với các service khác.

Cách 2: Chạy riêng
  cd gateway
  mvn clean install
  mvn spring-boot:run

KIỂM TRA GATEWAY
----------------

Health Check:
  curl http://localhost:8000/health/status

API Request (qua Gateway):
  
  # Login
  curl -X POST http://localhost:8000/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username":"admin","password":"admin123"}'
  
  # Get Products
  curl http://localhost:8000/api/products
  
  # AI Service
  curl http://localhost:8000/ai/analyze \
    -H "Content-Type: application/json" \
    -d '{"data":"test"}'

LOGS & MONITORING
-----------------

View Logs:
  docker logs bizflow-gateway -f

Metrics:
  curl http://localhost:8000/actuator/metrics

Health Detail:
  curl http://localhost:8000/actuator/health

TROUBLESHOOTING
---------------

1. Gateway không kết nối được đến Backend
   Lỗi: Cannot assign requested address
   
   Giải pháp:
   - Đảm bảo Backend đã start: docker ps | grep backend
   - Kiểm tra network: docker network inspect bizflow-net

2. CORS Error
   Lỗi: Access to XMLHttpRequest from origin has been blocked by CORS policy
   
   Giải pháp:
   - CORS đã được cấu hình trong Gateway, nhưng nếu vẫn lỗi, kiểm tra:
     * Header từ client: Origin phải được set
     * Response phải có: Access-Control-Allow-Origin

3. Request Timeout
   Lỗi: 504 Gateway Timeout
   
   Giải pháp:
   - Kiểm tra backend service có đang chạy không
   - Kiểm tra network connectivity: docker exec bizflow-gateway ping backend

CẤU HÌNH ADVANCED
-----------------

Thêm Route Mới:
  Chỉnh sửa GatewayApplication.java:
  
  .route("new-service", r -> r
      .path("/new/**")
      .uri("http://new-service:port"))

Custom Filters:
  Tạo file:
  
  @Component
  public class CustomGatewayFilter implements GlobalFilter {
      @Override
      public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
          // Custom logic
          return chain.filter(exchange);
      }
  }

Rate Limiting:
  Thêm dependency:
  
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-circuitbreaker-resilience4j</artifactId>
  </dependency>

FILE STRUCTURE
--------------
gateway/
├── pom.xml                    # Maven dependencies
├── Dockerfile                 # Docker configuration
└── src/
    └── main/
        ├── java/
        │   └── com/example/gateway/
        │       └── GatewayApplication.java
        └── resources/
            └── application.yml

DÙNG GATEWAY ĐỂ GỌI API
-----------------------

Trước (trực tiếp đến Backend):
  http://localhost:8080/api/auth/login

Sau (qua Gateway):
  http://localhost:8000/api/auth/login

Frontend chỉ cần gọi đến Gateway (port 8000), Gateway sẽ route tới Backend 
hoặc AI Service.

LƯU Ý
-----
- Gateway là single point of entry
- Tất cả traffic phải đi qua Gateway
- Có thể thêm authentication, logging, rate limiting ở đây

HƯỚNG DẪN TEST PHÂN BIỆT ĐĂNG NHẬP
----------------------------------

1) So sánh bằng curl:
   
   Qua Gateway:
     curl -i -H "Content-Type: application/json" \
       -d '{"username":"<user>","password":"<pass>"}' \
       http://localhost:8000/api/auth/login

   Trực tiếp Backend:
     curl -i -H "Content-Type: application/json" \
       -d '{"username":"<user>","password":"<pass>"}' \
       http://localhost:8080/api/auth/login

   Khác biệt dễ thấy:
   - Header CORS: access-control-allow-origin qua Gateway được set tập trung.
   - Có thể thấy header Via (đi qua proxy) khi đi qua Gateway.
   - Log: request xuất hiện ở cả gateway và backend khi đi qua Gateway.

2) Dùng script so sánh nhanh:
   - File: scripts/login_test.sh
   - Cài jq nếu thiếu (macOS): brew install jq
   - Chạy:
     USERNAME=<user> PASSWORD=<pass> bash scripts/login_test.sh
   - Script in ra status, headers quan trọng và lưu body:
     /tmp/gateway_body.json, /tmp/backend_body.json

3) Theo dõi log để xác thực đường đi:
   docker logs bizflow-gateway -f
   docker logs bizflow-backend -f

4) Test bằng trình duyệt (Frontend):
   - Mở: http://localhost:3000/pages/login.html
   - Đăng nhập → FE gọi /api/auth/login (Nginx → Gateway → Backend)
   - Kiểm tra log như trên để thấy request đi qua Gateway.

================================================================================
