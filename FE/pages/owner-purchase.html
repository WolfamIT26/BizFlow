<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập Hàng & Giá Vốn - BizFlow</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        :root {
            --primary: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --muted: #6b7280;
            --bg-dark: #1f2937;
            --bg-card: #374151;
            --text: #f9fafb;
        }
        body {
            background: radial-gradient(1200px 800px at 20% -10%, rgba(79, 70, 229, 0.18), transparent 60%),
                        radial-gradient(900px 700px at 100% 10%, rgba(16, 185, 129, 0.12), transparent 55%),
                        var(--bg-dark);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: var(--primary); margin-bottom: 20px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 24px; background: rgba(55, 65, 81, 0.8); border: 1px solid rgba(148, 163, 184, 0.08); color: var(--text); cursor: pointer; border-radius: 10px 10px 0 0; font-size: 15px; transition: all 0.2s ease; }
        .tab-btn.active { background: linear-gradient(135deg, #4f46e5, #6366f1); border-color: rgba(99, 102, 241, 0.6); box-shadow: 0 10px 20px rgba(79, 70, 229, 0.35); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card {
            background: linear-gradient(180deg, rgba(55, 65, 81, 0.95), rgba(31, 41, 55, 0.9));
            border-radius: 14px;
            padding: 22px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35), inset 0 1px 0 rgba(255,255,255,0.03);
            border: 1px solid rgba(148, 163, 184, 0.08);
        }
        .card h2 { margin-top: 0; color: var(--success); font-size: 18px; letter-spacing: 0.2px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: rgba(226, 232, 240, 0.8); font-size: 13px; letter-spacing: 0.2px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 11px 12px; border: 1px solid rgba(71, 85, 105, 0.9); border-radius: 10px;
            background: rgba(15, 23, 42, 0.7); color: var(--text); box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: rgba(79, 70, 229, 0.8);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.22);
            background: rgba(15, 23, 42, 0.9);
        }
        .form-group.inline { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
        .checkbox-pill { display: inline-flex; align-items: center; gap: 10px; padding: 8px 16px; border-radius: 999px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.14), rgba(99, 102, 241, 0.08)); border: 1px solid rgba(99, 102, 241, 0.35); cursor: pointer; user-select: none; transition: all 0.2s ease; }
        .checkbox-pill:hover { background: linear-gradient(135deg, rgba(79, 70, 229, 0.22), rgba(99, 102, 241, 0.16)); border-color: rgba(99, 102, 241, 0.7); }
        .checkbox-pill input { position: absolute; opacity: 0; pointer-events: none; }
        .checkbox-box { width: 20px; height: 20px; border-radius: 7px; border: 2px solid rgba(148, 163, 184, 0.7); display: inline-flex; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.65); transition: all 0.2s ease; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.2); }
        .checkbox-box::after { content: ''; width: 8px; height: 5px; border-left: 2px solid #fff; border-bottom: 2px solid #fff; transform: rotate(-45deg) scale(0); transition: transform 0.2s ease; }
        .checkbox-text { color: rgba(226, 232, 240, 0.92); font-size: 14px; font-weight: 600; letter-spacing: 0.2px; }
        .checkbox-pill input:checked + .checkbox-box { background: linear-gradient(135deg, #4f46e5, #6366f1); border-color: #6366f1; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.25), 0 6px 12px rgba(79, 70, 229, 0.35); }
        .checkbox-pill input:checked + .checkbox-box::after { transform: rotate(-45deg) scale(1); }
        .checkbox-pill input:checked ~ .checkbox-text { color: #e0e7ff; }
        .checkbox-pill:has(input:checked) { border-color: rgba(99, 102, 241, 0.8); background: linear-gradient(135deg, rgba(79, 70, 229, 0.28), rgba(99, 102, 241, 0.2)); box-shadow: 0 8px 16px rgba(15, 23, 42, 0.3), inset 0 0 0 1px rgba(255,255,255,0.05); }
        .checkbox-pill input:focus-visible + .checkbox-box { outline: 2px solid rgba(245, 158, 11, 0.8); outline-offset: 2px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #4b5563; }
        th { background: var(--bg-dark); color: var(--muted); font-weight: 600; }
        tr:hover { background: rgba(79, 70, 229, 0.1); }
        
        .price { color: var(--success); font-weight: 600; }
        .quantity { color: var(--warning); font-weight: 600; }
        .total { color: var(--primary); font-weight: 700; }
        
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-card { background: var(--bg-card); padding: 20px; border-radius: 12px; text-align: center; }
        .summary-card .value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .summary-card .label { color: var(--muted); font-size: 14px; margin-top: 5px; }

        .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-end; }
        .filter-bar .form-group { margin-bottom: 0; }

        .cost-preview { background: rgba(79, 70, 229, 0.2); padding: 15px; border-radius: 8px; margin-top: 15px; }
        .cost-preview .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .cost-preview .label { color: var(--muted); }
        .cost-preview .value { font-weight: 600; }
        .cost-preview .total-row { border-top: 1px solid var(--primary); padding-top: 10px; margin-top: 10px; }
        .cost-preview .total-row .value { color: var(--primary); font-size: 20px; }

        .back-link { color: var(--primary); text-decoration: none; display: inline-block; margin-bottom: 20px; }
        .back-link:hover { text-decoration: underline; }
            body.in-drawer .sidebar {
            display: none;
        }
        body.in-drawer .layout {
            grid-template-columns: 1fr;
        }
        body.in-drawer .purchase-backdrop,
        body.in-drawer .purchase-drawer {
            display: none;
        }        body.in-drawer {
            --primary: #2f3a8f;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --muted: #6b7280;
            --bg-light: #f3f4f8;
            --card: #ffffff;
            --border: #e5e7eb;
            --text: #1f2937;
            background: var(--bg-light);
            color: var(--text);
        }
        body.in-drawer .container { max-width: 1200px; }
        body.in-drawer h1 { color: var(--primary); }
        body.in-drawer .tab-btn {
            background: #ffffff;
            border: 1px solid var(--border);
            color: var(--text);
            box-shadow: none;
        }
        body.in-drawer .tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #ffffff;
            box-shadow: 0 10px 24px rgba(47, 58, 143, 0.2);
        }
        body.in-drawer .card {
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: 0 10px 25px rgba(31, 41, 55, 0.08);
        }
        body.in-drawer .card h2 { color: var(--primary); }
        body.in-drawer .form-group label { color: var(--muted); }
        body.in-drawer .form-group input,
        body.in-drawer .form-group select,
        body.in-drawer .form-group textarea {
            background: #ffffff;
            color: var(--text);
            border: 1px solid var(--border);
        }
        body.in-drawer .form-group input:focus,
        body.in-drawer .form-group select:focus,
        body.in-drawer .form-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(47, 58, 143, 0.18);
        }
        body.in-drawer table { background: transparent; }
        body.in-drawer th { background: #f9fafb; border-bottom: 1px solid var(--border); color: var(--muted); }
        body.in-drawer td { border-bottom: 1px solid var(--border); }
        body.in-drawer tr:hover { background: #f3f4f6; }
        body.in-drawer .summary-card {
            background: #ffffff;
            border: 1px solid var(--border);
        }
        body.in-drawer .cost-preview {
            background: #eef2ff;
            border: 1px solid #e0e7ff;
        }
        body.in-drawer .checkbox-pill {
            background: #eef2ff;
            border: 1px solid #c7d2fe;
        }
        body.in-drawer .checkbox-text { color: var(--text); }
        body.in-drawer .checkbox-box {
            background: #ffffff;
            border: 2px solid #c7d2fe;
        }
        body.in-drawer .checkbox-pill input:checked + .checkbox-box {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(47, 58, 143, 0.18);
        }
        body.in-drawer .checkbox-pill input:checked ~ .checkbox-text { color: var(--text); }
        body.in-drawer .back-link { color: var(--primary); }        body.in-drawer.ui-refresh {
            background: #f4f6fb;
            color: #1f2937;
        }
        body.in-drawer.ui-refresh .container {
            max-width: 1040px;
            margin: 0 auto;
        }
        body.in-drawer.ui-refresh h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #1f2a66;
            font-weight: 700;
            font-size: 28px;
            margin: 8px 0 22px;
        }
        body.in-drawer.ui-refresh h1::before {
            content: "📦";
            font-size: 24px;
        }
        body.in-drawer.ui-refresh .tabs {
            justify-content: center;
            gap: 12px;
            margin-bottom: 18px;
        }
        body.in-drawer.ui-refresh .tab-btn {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            color: #1f2937;
            border-radius: 12px;
            padding: 10px 18px;
            box-shadow: 0 8px 16px rgba(31, 41, 55, 0.06);
        }
        body.in-drawer.ui-refresh .tab-btn.active {
            background: #2f3a8f;
            border-color: #2f3a8f;
            color: #ffffff;
            box-shadow: 0 12px 24px rgba(47, 58, 143, 0.25);
        }
        body.in-drawer.ui-refresh .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 22px 24px;
            box-shadow: 0 18px 30px rgba(31, 41, 55, 0.08);
        }
        body.in-drawer.ui-refresh .card h2 {
            color: #2f3a8f;
            font-size: 18px;
            margin-bottom: 14px;
        }
        body.in-drawer.ui-refresh .form-grid {
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }
        body.in-drawer.ui-refresh .form-group label {
            color: #6b7280;
            font-weight: 600;
        }
        body.in-drawer.ui-refresh .form-group input,
        body.in-drawer.ui-refresh .form-group select,
        body.in-drawer.ui-refresh .form-group textarea {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
        }
        body.in-drawer.ui-refresh .form-group input:focus,
        body.in-drawer.ui-refresh .form-group select:focus,
        body.in-drawer.ui-refresh .form-group textarea:focus {
            border-color: #2f3a8f;
            box-shadow: 0 0 0 3px rgba(47, 58, 143, 0.15);
        }
        body.in-drawer.ui-refresh .checkbox-pill {
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 999px;
        }
        body.in-drawer.ui-refresh .checkbox-text {
            color: #1f2937;
        }
        body.in-drawer.ui-refresh .btn-success {
            background: #16a34a;
            border-radius: 12px;
            padding: 10px 18px;
            box-shadow: 0 10px 20px rgba(22, 163, 74, 0.2);
        }
        body.in-drawer.ui-refresh .summary-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
        }
        body.in-drawer.ui-refresh th {
            background: #f8fafc;
            color: #6b7280;
        }
        body.in-drawer.ui-refresh tr:hover {
            background: #f3f4f6;
        }
        @media (max-width: 900px) {
            body.in-drawer.ui-refresh .form-grid { grid-template-columns: 1fr; }
            body.in-drawer.ui-refresh h1 { font-size: 24px; }
        }</style>
</head>
<body>
    <div class="container">
<h1>📦 Nhập Hàng & Quản Lý Giá Vốn</h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('purchase')">Nhập Hàng Mới</button>
            <button class="tab-btn" onclick="showTab('history')">Lịch Sử Nhập Hàng</button>
            <button class="tab-btn" onclick="showTab('costs')">Giá Vốn Hiện Tại</button>
        </div>

        <!-- Tab: Nhập hàng mới -->
        <div id="tab-purchase" class="tab-content active">
            <div class="card">
                <h2>➕ Nhập Hàng Mới</h2>
                <form id="purchaseForm" onsubmit="submitPurchase(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Sản phẩm *</label>
                            <select id="purchaseProduct" required onchange="updateCostPreview()">
                                <option value="">-- Chọn sản phẩm --</option>
                            </select>
                            <div class="form-group inline">
                                <label class="checkbox-pill" for="isNewProduct">
                                    <input type="checkbox" id="isNewProduct" onchange="toggleNewProduct(this.checked)">
                                    <span class="checkbox-box" aria-hidden="true"></span>
                                    <span class="checkbox-text">San pham moi (chua co trong cua hang)</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Giá vốn mới (VNĐ) *</label>
                            <input type="number" id="purchaseCostPrice" required min="0" step="100" oninput="updateCostPreview()">
                        </div>
                        <div class="form-group">
                            <label>Số lượng nhập *</label>
                            <input type="number" id="purchaseQuantity" required min="1" value="1" oninput="updateCostPreview()">
                        </div>
                    </div>
                    <div id="newProductFields" style="display:none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ten san pham *</label>
                                <input type="text" id="newProductName" placeholder="VD: Sua tuoi Vinamilk 1L">
                            </div>
                            <div class="form-group">
                                <label>Ma san pham (SKU) *</label>
                                <input type="text" id="newProductCode" placeholder="VD: VM-1L">
                            </div>
                            <div class="form-group">
                                <label>Gia ban *</label>
                                <input type="number" id="newProductPrice" min="0" step="100" placeholder="VD: 25000">
                            </div>
                            <div class="form-group">
                                <label>Gia von nhap *</label>
                                <input type="number" id="newProductCostPrice" min="0" step="100" placeholder="VD: 15000" oninput="syncCostPrice('newProductCostPrice','purchaseCostPrice'); updateCostPreview()">
                            </div>
                            <div class="form-group">
                                <label>Don vi</label>
                                <input type="text" id="newProductUnit" placeholder="VD: chai, hop, goi">
                            </div>
                            <div class="form-group">
                                <label>Barcode</label>
                                <input type="text" id="newProductBarcode" placeholder="VD: 893...">
                            </div>
                            <div class="form-group">
                                <label>Category ID</label>
                                <input type="number" id="newProductCategory" min="1" step="1" placeholder="VD: 1">
                            </div>
                            <div class="form-group">
                                <label>Anh san pham *</label>
                                <input type="file" id="newProductImage" accept=".jpg,.jpeg,.png,.webp">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Mo ta</label>
                                <textarea id="newProductDescription" rows="2" placeholder="Mo ta ngan ve san pham"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ghi chú</label>
                        <textarea id="purchaseNote" rows="2" placeholder="VD: Nhập từ NCC ABC, ngày 15/01/2026..."></textarea>
                    </div>

                    <div class="cost-preview" id="costPreview" style="display:none;">
                        <div class="row">
                            <span class="label">Giá vốn cũ:</span>
                            <span class="value" id="oldCostPrice">--</span>
                        </div>
                        <div class="row">
                            <span class="label">Giá vốn mới:</span>
                            <span class="value price" id="newCostPrice">--</span>
                        </div>
                        <div class="row">
                            <span class="label">Tồn kho hiện tại:</span>
                            <span class="value" id="currentStock">--</span>
                        </div>
                        <div class="row">
                            <span class="label">Số lượng nhập:</span>
                            <span class="value quantity" id="previewQuantity">--</span>
                        </div>
                        <div class="row">
                            <span class="label">Tồn kho sau nhập:</span>
                            <span class="value" style="color:var(--success)" id="newStock">--</span>
                        </div>
                        <div class="row total-row">
                            <span class="label">Tổng tiền nhập:</span>
                            <span class="value total" id="totalCost">--</span>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <button type="submit" class="btn btn-success">✅ Xác nhận nhập hàng</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tab: Lịch sử nhập hàng -->
        <div id="tab-history" class="tab-content">
            <div class="card">
                <h2>📋 Lịch Sử Nhập Hàng</h2>
                
                <div class="filter-bar">
                    <div class="form-group">
                        <label>Từ ngày</label>
                        <input type="date" id="historyStartDate">
                    </div>
                    <div class="form-group">
                        <label>Đến ngày</label>
                        <input type="date" id="historyEndDate">
                    </div>
                    <div class="form-group">
                        <label>Sản phẩm</label>
                        <select id="historyProduct">
                            <option value="">-- Tất cả --</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="loadHistory()">🔍 Lọc</button>
                </div>

                <div class="summary-cards" id="historySummary">
                    <div class="summary-card">
                        <div class="value" id="totalPurchases">0</div>
                        <div class="label">Lần nhập</div>
                    </div>
                    <div class="summary-card">
                        <div class="value" id="totalQuantityIn">0</div>
                        <div class="label">Tổng SL nhập</div>
                    </div>
                    <div class="summary-card">
                        <div class="value" id="totalCostSpent">0đ</div>
                        <div class="label">Tổng tiền nhập</div>
                    </div>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Sản phẩm</th>
                            <th>Giá vốn</th>
                            <th>Số lượng</th>
                            <th>Tổng tiền</th>
                            <th>Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <tr><td colspan="6" style="text-align:center;color:var(--muted)">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Giá vốn hiện tại -->
        <div id="tab-costs" class="tab-content">
            <div class="card">
                <h2>💰 Giá Vốn Hiện Tại Của Sản Phẩm</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Mã SP</th>
                            <th>Tên sản phẩm</th>
                            <th>Giá bán</th>
                            <th>Giá vốn</th>
                            <th>Lợi nhuận</th>
                            <th>Tỉ lệ LN</th>
                            <th>Cập nhật lần cuối</th>
                        </tr>
                    </thead>
                    <tbody id="costsTable">
                        <tr><td colspan="7" style="text-align:center;color:var(--muted)">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = resolveApiBase();
        let allProducts = [];
        let productCosts = {};

        function resolveApiBase() {
            const configured = window.API_BASE_URL || window.API_BASE;
            if (configured) return configured.replace(/\/$/, '');
            if (window.location.protocol === 'file:' || (window.location.hostname === 'localhost' && window.location.port === '3000')) {
                return 'http://localhost:8080/api';
            }
            return `${window.location.origin}/api`;
        }

        function getAuthToken() {
            return sessionStorage.getItem('accessToken') || localStorage.getItem('token');
        }

        function getAuthHeaders() {
            const token = getAuthToken();
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            return date.toLocaleString('vi-VN');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');

            if (tabName === 'history') loadHistory();
            if (tabName === 'costs') loadCurrentCosts();
        }

        async function loadProducts() {
            try {
                const res = await fetch(`${API_BASE}/products`, { headers: getAuthHeaders() });
                if (res.ok) {
                    allProducts = await res.json();
                    populateProductSelects();
                } else {
                    populateProductSelects(true);
                }
            } catch (e) {
                console.error('Error loading products:', e);
                populateProductSelects(true);
            }
        }

        function populateProductSelects(hasError) {
            const purchaseSelect = document.getElementById('purchaseProduct');
            const historySelect = document.getElementById('historyProduct');
            const fallback = hasError ? '<option value="">-- Không tải được sản phẩm --</option>' : '<option value="">-- Chọn sản phẩm --</option>';
            const options = (allProducts || []).map(p =>
                `<option value="${p.id}" data-cost="${p.costPrice || 0}">${p.code || p.id} - ${p.name || 'Sản phẩm'}</option>`
            ).join('');

            purchaseSelect.innerHTML = fallback + options;
            historySelect.innerHTML = (hasError ? '<option value="">-- Không tải được sản phẩm --</option>' : '<option value="">-- Tất cả --</option>') + options;
        }

        function isNewProductMode() {
            const toggle = document.getElementById('isNewProduct');
            return !!(toggle && toggle.checked);
        }

        function syncCostPrice(fromId, toId) {
            const from = document.getElementById(fromId);
            const to = document.getElementById(toId);
            if (!from || !to) {
                return;
            }
            to.value = from.value;
        }

        function generateUniqueSku() {
            const existing = new Set((allProducts || []).map(p => (p.code || '').toString().trim().toUpperCase()));
            for (let i = 0; i < 50; i++) {
                const candidate = `SP${Math.floor(10000 + Math.random() * 90000)}`;
                if (!existing.has(candidate)) {
                    return candidate;
                }
            }
            return `SP${Date.now().toString().slice(-6)}`;
        }

        function generateUniqueBarcode() {
            const existing = new Set((allProducts || []).map(p => (p.barcode || '').toString().trim()));
            for (let i = 0; i < 50; i++) {
                let barcode = '';
                for (let j = 0; j < 13; j++) {
                    barcode += Math.floor(Math.random() * 10).toString();
                }
                if (!existing.has(barcode)) {
                    return barcode;
                }
            }
            return Date.now().toString().slice(-13);
        }

        function pickRandomCategoryId() {
            const categoryIds = (allProducts || [])
                .map(p => p.categoryId)
                .filter(id => Number.isFinite(Number(id)))
                .map(id => Number(id));
            const unique = Array.from(new Set(categoryIds));
            if (unique.length === 0) {
                return '';
            }
            const randomIndex = Math.floor(Math.random() * unique.length);
            return unique[randomIndex].toString();
        }

        function applyAutoCodesIfEmpty() {
            const codeInput = document.getElementById('newProductCode');
            const barcodeInput = document.getElementById('newProductBarcode');
            const categoryInput = document.getElementById('newProductCategory');
            if (codeInput && !codeInput.value.trim()) {
                codeInput.value = generateUniqueSku();
            }
            if (barcodeInput && !barcodeInput.value.trim()) {
                barcodeInput.value = generateUniqueBarcode();
            }
            if (categoryInput && !categoryInput.value.trim()) {
                const picked = pickRandomCategoryId();
                if (picked) {
                    categoryInput.value = picked;
                }
            }
        }

        function toggleNewProduct(isNew) {
            const purchaseSelect = document.getElementById('purchaseProduct');
            const newFields = document.getElementById('newProductFields');
            const purchaseCostGroup = document.getElementById('purchaseCostGroup');
            const newCostField = document.getElementById('newProductCostPrice');
            if (newFields) {
                newFields.style.display = isNew ? 'block' : 'none';
            }
            if (purchaseSelect) {
                purchaseSelect.disabled = isNew;
                purchaseSelect.required = !isNew;
                if (isNew) {
                    purchaseSelect.value = '';
                }
            }

            const requiredFields = [
                'newProductName',
                'newProductCode',
                'newProductPrice',
                'newProductImage',
                'newProductCostPrice'
            ];
            requiredFields.forEach((id) => {
                const field = document.getElementById(id);
                if (field) {
                    field.required = isNew;
                }
            });

            if (purchaseCostGroup) {
                purchaseCostGroup.style.display = isNew ? 'none' : 'block';
            }
            if (newCostField) {
                if (isNew) {
                    newCostField.value = document.getElementById('purchaseCostPrice')?.value || '';
                }
            }

            if (isNew) {
                applyAutoCodesIfEmpty();
            }

            updateCostPreview();
        }

        async function uploadProductImage(productName, file) {
            const token = getAuthToken();
            const formData = new FormData();
            formData.append('productName', productName);
            formData.append('file', file);

            const res = await fetch(`${API_BASE}/product-images`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            if (!res.ok) {
                let message = 'Khong the tai anh san pham';
                try {
                    const data = await res.json();
                    if (data && data.error) message = data.error;
                } catch (e) {
                }
                throw new Error(message);
            }

            return res.json();
        }

        function updateCostPreview() {
            const select = document.getElementById('purchaseProduct');
            const productId = select ? select.value : '';
            const preview = document.getElementById('costPreview');
            const isNew = isNewProductMode();
            
            if (!productId && !isNew) {
                preview.style.display = 'none';
                return;
            }

            const product = !isNew ? allProducts.find(p => p.id == productId) : null;
            const oldCost = product ? (product.costPrice || 0) : 0;
            const currentStock = product ? (product.stock || 0) : 0;
            const newCost = parseFloat(document.getElementById('purchaseCostPrice').value) || 0;
            const quantity = parseInt(document.getElementById('purchaseQuantity').value) || 1;
            const total = newCost * quantity;
            const newStock = currentStock + quantity;

            document.getElementById('oldCostPrice').textContent = formatCurrency(oldCost);
            document.getElementById('newCostPrice').textContent = formatCurrency(newCost);
            document.getElementById('currentStock').textContent = currentStock;
            document.getElementById('previewQuantity').textContent = quantity;
            document.getElementById('newStock').textContent = newStock;
            document.getElementById('totalCost').textContent = formatCurrency(total);

            preview.style.display = 'block';
        }
        async function submitPurchase(event) {
            event.preventDefault();

            const costPrice = parseFloat(document.getElementById('purchaseCostPrice').value);
            const quantity = parseInt(document.getElementById('purchaseQuantity').value);
            const note = document.getElementById('purchaseNote').value;
            const isNew = isNewProductMode();

            if (!costPrice || !quantity) {
                alert('Vui long nhap day du thong tin');
                return;
            }

            try {
                if (isNew) {
                    applyAutoCodesIfEmpty();
                    const name = (document.getElementById('newProductName').value || '').trim();
                    const code = (document.getElementById('newProductCode').value || '').trim();
                    const barcode = (document.getElementById('newProductBarcode').value || '').trim();
                    const unit = (document.getElementById('newProductUnit').value || '').trim();
                    const description = (document.getElementById('newProductDescription').value || '').trim();
                    const price = parseFloat(document.getElementById('newProductPrice').value);
                    const categoryRaw = document.getElementById('newProductCategory').value;
                    const categoryId = categoryRaw ? parseInt(categoryRaw, 10) : null;
                    const imageInput = document.getElementById('newProductImage');
                    const imageFile = imageInput && imageInput.files ? imageInput.files[0] : null;

                    if (!name || !code || !Number.isFinite(price) || price <= 0) {
                        alert('Vui long nhap day du thong tin san pham moi');
                        return;
                    }
                    if (!imageFile) {
                        alert('Vui long chon anh san pham');
                        return;
                    }

                    await uploadProductImage(name, imageFile);

                    const payload = {
                        code,
                        name,
                        barcode: barcode || null,
                        price,
                        costPrice,
                        quantity,
                        unit: unit || null,
                        description: description || null,
                        categoryId,
                        note: note || null
                    };

                    const res = await fetch(`${API_BASE}/product-costs/purchase/new-product`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || 'Khong the nhap hang san pham moi');
                    }
                } else {
                    const productId = document.getElementById('purchaseProduct').value;
                    if (!productId) {
                        alert('Vui long chon san pham');
                        return;
                    }
                    const res = await fetch(`${API_BASE}/product-costs/purchase`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ productId, costPrice, quantity, note })
                    });

                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || 'Khong the nhap hang');
                    }
                }

                alert('Da nhap hang thanh cong! Gia von da duoc cap nhat.');
                document.getElementById('purchaseForm').reset();
                const newToggle = document.getElementById('isNewProduct');
                if (newToggle) {
                    newToggle.checked = false;
                }
                toggleNewProduct(false);
                document.getElementById('costPreview').style.display = 'none';
                loadProducts();
            } catch (e) {
                console.error('Error submitting purchase:', e);
                alert('Loi: ' + (e.message || 'Loi ket noi server'));
            }
        }

        async function loadHistory() {
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            const productId = document.getElementById('historyProduct').value;

            try {
                let url = `${API_BASE}/product-costs/history`;
                const params = new URLSearchParams();
                
                if (startDate && endDate) {
                    url = `${API_BASE}/product-costs/history/range`;
                    params.append('startDate', startDate);
                    params.append('endDate', endDate);
                    if (productId) params.append('productId', productId);
                } else if (productId) {
                    url = `${API_BASE}/product-costs/${productId}/history`;
                }

                const finalUrl = params.toString() ? `${url}?${params}` : url;
                const res = await fetch(finalUrl, { headers: getAuthHeaders() });
                
                if (res.ok) {
                    const history = await res.json();
                    renderHistory(history);
                }
            } catch (e) {
                console.error('Error loading history:', e);
            }
        }

        function renderHistory(history) {
            const tbody = document.getElementById('historyTable');
            
            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted)">Không có dữ liệu</td></tr>';
                updateHistorySummary(0, 0, 0);
                return;
            }

            let totalQuantity = 0;
            let totalCost = 0;

            tbody.innerHTML = history.map(h => {
                const itemTotal = (h.costPrice || 0) * (h.quantity || 0);
                totalQuantity += h.quantity || 0;
                totalCost += itemTotal;
                
                return `
                    <tr>
                        <td>${formatDateTime(h.createdAt)}</td>
                        <td><strong>${h.productCode || ''}</strong> - ${h.productName || 'N/A'}</td>
                        <td class="price">${formatCurrency(h.costPrice)}</td>
                        <td class="quantity">${h.quantity || 0}</td>
                        <td class="total">${formatCurrency(itemTotal)}</td>
                        <td style="color:var(--muted)">${h.note || '--'}</td>
                    </tr>
                `;
            }).join('');

            updateHistorySummary(history.length, totalQuantity, totalCost);
        }

        function updateHistorySummary(count, quantity, cost) {
            document.getElementById('totalPurchases').textContent = count;
            document.getElementById('totalQuantityIn').textContent = quantity;
            document.getElementById('totalCostSpent').textContent = formatCurrency(cost);
        }

        async function loadCurrentCosts() {
            try {
                // Load products with their current costs
                const res = await fetch(`${API_BASE}/products`, { headers: getAuthHeaders() });
                if (res.ok) {
                    const products = await res.json();
                    renderCurrentCosts(products);
                }
            } catch (e) {
                console.error('Error loading current costs:', e);
            }
        }

        function renderCurrentCosts(products) {
            const tbody = document.getElementById('costsTable');
            
            if (!products || products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted)">Không có dữ liệu</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(p => {
                const profit = (p.price || 0) - (p.costPrice || 0);
                const profitPercent = p.costPrice ? ((profit / p.costPrice) * 100).toFixed(1) : 0;
                const profitColor = profit > 0 ? 'var(--success)' : (profit < 0 ? 'var(--danger)' : 'var(--muted)');
                
                return `
                    <tr>
                        <td><strong>${p.code || ''}</strong></td>
                        <td>${p.name || ''}</td>
                        <td>${formatCurrency(p.price)}</td>
                        <td class="price">${p.costPrice ? formatCurrency(p.costPrice) : '<span style="color:var(--warning)">Chưa có</span>'}</td>
                        <td style="color:${profitColor};font-weight:600">${formatCurrency(profit)}</td>
                        <td style="color:${profitColor}">${profitPercent}%</td>
                        <td style="color:var(--muted)">--</td>
                    </tr>
                `;
            }).join('');
        }

        // Set default date range
        function setDefaultDates() {
            const today = new Date();
            const firstOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('historyStartDate').value = firstOfMonth.toISOString().split('T')[0];
            document.getElementById('historyEndDate').value = today.toISOString().split('T')[0];
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDates();
            loadProducts();
        });
    </script>
    <script>
        if (window.self !== window.top) {
            document.body.classList.add('in-drawer');
        }
    </script></body>
</html>








